@page "/jobs/{DetailsPage}/{Id:guid}"

@inject IDbContextFactory<EtlManagerContext> DbFactory
@inject IWebHostEnvironment WebHostEnvironment
@inject IConfiguration configuration
@inject IJSRuntime JsRuntime
@inject NavigationManager NavigationManager
@inject IHttpContextAccessor HttpContextAccessor

<div class="row">
    <div class="col-auto">
        <BSButtonGroup>
            <BSDropdown IsGroup="true">
                <BSDropdownToggle Color="Color.Secondary">
                    @((MarkupString)System.IO.File.ReadAllText(System.IO.Path.Combine(WebHostEnvironment.WebRootPath, "icons/feather/loader.svg")))
                    @(CurrentJob?.JobName ?? "Loading...")
                </BSDropdownToggle>
                <BSDropdownMenu>
                    <BSDropdownHeader>Show</BSDropdownHeader>
                    @if (Jobs is not null)
                    {
                        @foreach (var job in Jobs)
                        {
                            <NavLink class="btn dropdown-item" href="@("jobs/" + DetailsPage + "/" + job.JobId)">@job.JobName</NavLink>
                        }
                    }
                </BSDropdownMenu>
            </BSDropdown>
            <BSButton Id="btn_description" Color="Color.Secondary" @onclick="() => DescriptionOpen = !DescriptionOpen" Class="@(string.IsNullOrWhiteSpace(CurrentJob?.JobDescription) ? "disabled" : DescriptionOpen ? "active" : null)">
                @((MarkupString)System.IO.File.ReadAllText(System.IO.Path.Combine(WebHostEnvironment.WebRootPath, "icons/feather/info.svg")))
            </BSButton>
        </BSButtonGroup>
        <BSTooltip Target="btn_description" Placement="Placement.Right">@(string.IsNullOrWhiteSpace(CurrentJob?.JobDescription) ? "No job description" : "Show/hide description")</BSTooltip>

    </div>

    <div class="col-xl d-xl-flex justify-content-xl-end mt-4 mt-xl-0">
        <div class="btn-toolbar">
            <BSButton Color="Subscribed ? Color.Success : Color.Secondary" @onclick="ToggleSubscription">
                @((MarkupString)System.IO.File.ReadAllText(System.IO.Path.Combine(WebHostEnvironment.WebRootPath, "icons/feather/mail.svg")))
                Subscribe
            </BSButton>

            <AuthorizeView Roles="Admin, Editor">
                @*Dropdown to change the current job's name*@
                <BSDropdown Class="ml-3">
                    <BSDropdownToggle Color="Color.Secondary">
                        @((MarkupString)System.IO.File.ReadAllText(System.IO.Path.Combine(WebHostEnvironment.WebRootPath, "icons/feather/edit-2.svg")))
                        Edit
                    </BSDropdownToggle>
                    <BSDropdownMenu Class="dropdown-menu-xl-right p-4" style="min-width: 30rem;">
                        <BSForm Model="EditJob" OnValidSubmit="UpdateJob" Context="_context">
                            <DataAnnotationsValidator />
                            <ValidationSummary />
                            <BSFormGroup>
                                <BSLabel>Name</BSLabel>
                                <InputText class="form-control" @bind-Value="EditJob.JobName" autocomplete="off"></InputText>
                            </BSFormGroup>
                            <BSFormGroup>
                                <BSLabel>Description</BSLabel>
                                <InputTextArea class="form-control form-control-sm" @bind-Value="EditJob.JobDescription" rows="5"></InputTextArea>
                            </BSFormGroup>
                            <BSButton Size="Size.Small" ButtonType="ButtonType.Submit" Color="Color.Success">Save</BSButton>
                        </BSForm>
                    </BSDropdownMenu>
                </BSDropdown>

                @*Dropdown to delete the current job*@
                <BSDropdown Class="ml-3">
                    <BSDropdownToggle Color="BlazorStrap.Color.Secondary">
                        @((MarkupString)System.IO.File.ReadAllText(System.IO.Path.Combine(WebHostEnvironment.WebRootPath, "icons/feather/trash-2.svg")))
                        Delete
                    </BSDropdownToggle>
                    <BSDropdownMenu Class="dropdown-menu-xl-right">
                        <BSDropdownHeader>Delete job?</BSDropdownHeader>
                        <BSDropdownItem @onclick="DeleteJob">Confirm</BSDropdownItem>
                    </BSDropdownMenu>
                </BSDropdown>
            </AuthorizeView>
        </div>
    </div>
</div>

@if (DescriptionOpen && !string.IsNullOrWhiteSpace(CurrentJob?.JobDescription))
{
    <div class="row mt-3">
        <div class="col">
            <text class="text-secondary font-italic" style="white-space: pre-line;">@CurrentJob?.JobDescription</text>
        </div>
    </div>
}


<div class="row flex-column-reverse flex-xl-row align-items-center">
    <div class="col-xl-7">
        <ul class="nav nav-pills mt-4 mb-4" role="tablist">
            <li class="nav-item" role="presentation">
                <NavLink class="nav-link" href="@("jobs/steps/" + CurrentJob?.JobId)">
                    @((MarkupString)System.IO.File.ReadAllText(System.IO.Path.Combine(WebHostEnvironment.WebRootPath, "icons/feather/list.svg")))
                    Steps
                </NavLink>
            </li>
            <li class="nav-item" role="presentation">
                <NavLink class="nav-link" href="@("jobs/dependencies/" + CurrentJob?.JobId)">
                    @((MarkupString)System.IO.File.ReadAllText(System.IO.Path.Combine(WebHostEnvironment.WebRootPath, "icons/bootstrap/diagram-3-fill.svg")))
                    Dependencies
                </NavLink>
            </li>
            <li class="nav-item" role="presentation">
                <NavLink class="nav-link" href="@("jobs/schedules/" + CurrentJob?.JobId)">
                    @((MarkupString)System.IO.File.ReadAllText(System.IO.Path.Combine(WebHostEnvironment.WebRootPath, "icons/feather/calendar.svg")))
                    Schedules
                </NavLink>
            </li>
            <li class="nav-item" role="presentation">
                <NavLink class="nav-link" href="@("jobs/jobhistory/" + CurrentJob?.JobId)">
                    @((MarkupString)System.IO.File.ReadAllText(System.IO.Path.Combine(WebHostEnvironment.WebRootPath, "icons/feather/activity.svg")))
                    History
                </NavLink>
            </li>
        </ul>
    </div>
    <div class="col-xl-5 d-xl-flex justify-content-xl-end mt-4 mt-xl-0">
        <div class="btn-toolbar align-items-center">
            @*Show switches to display whether the jos is enabled or disabled and whether the job uses dependency mode or not.*@
            <AuthorizeView Roles="Admin, Editor">
                <div class="custom-control custom-switch">
                    <input type="checkbox" class="custom-control-input" id="job_enabled_toggle" checked="@(CurrentJob?.IsEnabled ?? false ? "checked" : null)" @onchange="ToggleJobEnabled">
                    <label class="custom-control-label" style="cursor: pointer;" for="job_enabled_toggle">Enabled</label>
                </div>
                <div class="custom-control custom-switch ml-4">
                    <input type="checkbox" class="custom-control-input" id="dependency_mode_toggle" checked="@(CurrentJob?.UseDependencyMode ?? false ? "checked" : null)" @onchange="ToggleDependencyMode">
                    <label class="custom-control-label" style="cursor: pointer;" for="dependency_mode_toggle">Dependency mode</label>
                </div>
            </AuthorizeView>
            <AuthorizeView Roles="Operator, Viewer">
                <div class="custom-control custom-switch">
                    <input type="checkbox" class="custom-control-input" disabled id="job_enabled_toggle" checked="@(CurrentJob?.IsEnabled ?? false ? "checked" : null)">
                    <label class="custom-control-label" for="job_enabled_toggle">Enabled</label>
                </div>
                <div class="custom-control custom-switch ml-4">
                    <input type="checkbox" class="custom-control-input" disabled id="dependency_mode_toggle" checked="@(CurrentJob?.UseDependencyMode ?? false ? "checked" : null)">
                    <label class="custom-control-label" for="dependency_mode_toggle">Dependency mode</label>
                </div>
            </AuthorizeView>
        </div>
    </div>
</div>


@if (DetailsPage == "steps")
{
    <StepsComponent Job="CurrentJob" Jobs="Jobs" Steps="Steps" Connections="Connections" DataFactories="DataFactories" PowerBIServices="PowerBIServices" />
}
else if (DetailsPage == "jobhistory")
{
    <JobHistoryComponent Id="Id" />
}
else if (DetailsPage == "dependencies")
{
    <DependenciesComponent Jobs="Jobs" Job="CurrentJob" Steps="Steps" Connections="Connections" DataFactories="DataFactories" PowerBIServices="PowerBIServices" />
}
else if (DetailsPage == "schedules")
{
    <SchedulesComponent Id="Id" />
}
else
{
    <p>No component to show.</p>
}


@code {
    [Parameter]
    public string? DetailsPage { get; set; }

    [Parameter]
    public Guid Id { get; set; }

    private Guid PrevId { get; set; }

    private Job CurrentJob { get; set; } = null!;

    private List<Job> Jobs { get; set; } = null!;

    private List<Step> Steps { get; set; } = null!;

    private Job EditJob { get; set; } = new();

    private List<Connection>? Connections { get; set; }
    private List<DataFactory>? DataFactories { get; set; }
    private List<PowerBIService>? PowerBIServices { get; set; }

    private string? Username => HttpContextAccessor.HttpContext?.User?.Identity?.Name;

    private bool Subscribed => CurrentJob?.Subscriptions.Any(sub => sub.Username == Username) ?? false;

    private bool DescriptionOpen { get; set; }

    protected override async Task OnInitializedAsync()
    {
        using var context = DbFactory.CreateDbContext();
        Jobs = await context.Jobs.Include(job => job.Subscriptions).OrderBy(job => job.JobName).ToListAsync();
        Connections = await context.Connections.AsNoTracking().OrderBy(c => c.ConnectionName).ToListAsync();
        DataFactories = await context.DataFactories.AsNoTracking().OrderBy(df => df.DataFactoryName).ToListAsync();
        PowerBIServices = await context.PowerBIServices.AsNoTracking().OrderBy(pbi => pbi.PowerBIServiceName).ToListAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        if (Id != PrevId)
        {
            PrevId = Id;
            await LoadData();
        }
    }

    private async Task LoadData()
    {
        CurrentJob = Jobs.First(job => job.JobId == Id);
        EditJob.JobName = CurrentJob.JobName;
        EditJob.JobDescription = CurrentJob.JobDescription;

        using var context = DbFactory.CreateDbContext();
        Steps = await context.Steps
            .Include(step => step.Dependencies)
            .Include(step => step.Tags)
            .Include(step => (step as PackageStep)!.PackageParameters)
            .Include(step => (step as PipelineStep)!.PipelineParameters)
            .Where(step => step.JobId == CurrentJob.JobId)
            .OrderBy(step => step.ExecutionPhase)
            .ThenBy(step => step.StepName)
            .ToListAsync();
    }

    private async Task UpdateJob()
    {
        try
        {
            using var context = DbFactory.CreateDbContext();
            CurrentJob.JobName = EditJob.JobName;
            CurrentJob.JobDescription = EditJob.JobDescription;
            context.Attach(CurrentJob).State = EntityState.Modified;
            await context.SaveChangesAsync();
        }
        catch (DbUpdateConcurrencyException)
        {
            await JsRuntime.InvokeVoidAsync("alert", "Concurrency error: the job was modified outside of this session. Reload the page to view the most recent values.");
        }
        catch (Exception ex)
        {
            await JsRuntime.InvokeVoidAsync("alert", "Error updating job: " + ex.Message);
        }
    }

    private async Task DeleteJob()
    {
        try
        {
            using var context = DbFactory.CreateDbContext();
            context.Jobs.Remove(CurrentJob);
            await context.SaveChangesAsync();
            await Utility.SchedulerServiceDeleteJobAsync(CurrentJob);
            NavigationManager.NavigateTo("jobs");
        }
        catch (Exception ex)
        {
            await JsRuntime.InvokeVoidAsync("alert", "Error deleting job: " + ex.Message);
        }
    }

    private async Task ToggleJobEnabled(ChangeEventArgs args)
    {
        bool value = (bool)args.Value!;
        try
        {
            await Utility.ToggleJobEnabledAsync(configuration, CurrentJob, value);
            CurrentJob.IsEnabled = !CurrentJob.IsEnabled;
        }
        catch (Exception ex)
        {
            await JsRuntime.InvokeVoidAsync("alert", "Error enabling/disabling job: " + ex.Message);
        }
    }

    private async Task ToggleDependencyMode(ChangeEventArgs args)
    {
        bool value = (bool)args.Value!;
        try
        {
            await Utility.ToggleJobDependencyModeAsync(configuration, CurrentJob, value);
            CurrentJob.UseDependencyMode = !CurrentJob.UseDependencyMode;
        }
        catch (Exception ex)
        {
            await JsRuntime.InvokeVoidAsync("alert", "Error toggling job dependency mode: " + ex.Message);
        }
    }

    private async Task ToggleSubscription()
    {
        using var context = DbFactory.CreateDbContext();
        var subscription = CurrentJob.Subscriptions.FirstOrDefault(sub => sub.Username == Username);
        try
        {
            if (subscription is not null)
            {
                context.Subscriptions.Remove(subscription);
                CurrentJob.Subscriptions.Remove(subscription);
            }
            else
            {
                var newSub = new Subscription { JobId = CurrentJob.JobId, Username = Username };
                context.Subscriptions.Add(newSub);
                CurrentJob.Subscriptions.Add(newSub);
            }
            await context.SaveChangesAsync();
        }
        catch (Exception ex)
        {
            await JsRuntime.InvokeVoidAsync("alert", "Error toggling subscription:" + ex.Message);
        }
    }

}
