@inject IDbContextFactory<BiflowContext> DbContextFactory
@inject IHxMessengerService Messenger

@{
    var title = Category.CategoryId == Guid.Empty ? "New category" : $"Edit {Category.CategoryName}";
}

<HxOffcanvas @ref="Offcanvas" Title="@title" Size="OffcanvasSize.Regular" Backdrop="OffcanvasBackdrop.False">
    <BodyTemplate>
        <EditForm id="category_edit_form" Model="Category" OnValidSubmit="SubmitAsync">
            <DataAnnotationsValidator />
            <ValidationSummary />
            <div>
                <label class="form-label">Category name</label>
                <InputText class="form-control" @bind-Value="Category.CategoryName"></InputText>
            </div>
        </EditForm>
    </BodyTemplate>
    <FooterTemplate>
        <HxSubmit FormId="category_edit_form" Color="ThemeColor.Success">
            Save
        </HxSubmit>
        <HxButton CssClass="ms-3" Color="ThemeColor.Secondary" OnClick="() => Offcanvas.LetAsync(x => x.HideAsync())" Spinner="false">
            Cancel
        </HxButton>
    </FooterTemplate>
</HxOffcanvas>

@code {
    [Parameter] public EventCallback<JobCategory> OnCategorySubmitted { get; set; }

    private HxOffcanvas? Offcanvas { get; set; }

    private JobCategory Category { get; set; } = new();

    public async Task ShowAsync(JobCategory? category = null)
    {
        if (category is null)
        {
            Category = new();
            await Offcanvas.LetAsync(x => x.ShowAsync());
            return;
        }
        using var context = await DbContextFactory.CreateDbContextAsync();
        Category = await context.JobCategories.FirstAsync(c => c.CategoryId == category.CategoryId);
        await Offcanvas.LetAsync(x => x.ShowAsync());
    }

    public async Task SubmitAsync()
    {
        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();
            if (Category.CategoryId == Guid.Empty)
            {
                context.JobCategories.Add(Category);
            }
            else
            {
                context.Attach(Category).State = EntityState.Modified;
            }
            await context.SaveChangesAsync();
            await OnCategorySubmitted.InvokeAsync(Category);
            await Offcanvas.LetAsync(x => x.HideAsync());
        }
        catch (Exception ex)
        {
            Messenger.AddError("Error saving category", ex.Message);
        }
    }
}
