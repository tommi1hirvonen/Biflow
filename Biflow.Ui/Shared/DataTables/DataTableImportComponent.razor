@using System.Data;
@using System.Text;
@inject IDbContextFactory<BiflowContext> DbContextFactory
@inject IHxMessengerService Messenger

@if (Table is null)
{
    <div class="row mt-5">
        <div class="col">
            <HxSpinner Color="ThemeColor.Secondary" />
        </div>
    </div>
    return;
}

<div class="row">
    <div class="col">
        <div>
            <a href="datatables">
                All data tables
            </a>
            <span>&nbsp;/&nbsp;</span>
            @if (Table.Category is not null)
            {
                <span>@Table.Category.CategoryName /&nbsp;</span>
            }
            <a href="datatables/edit/@Table.DataTableId">
                @Table.DataTableName
            </a>
            <span>&nbsp;/</span>
            <strong>Import data</strong>
        </div>
    </div>
</div>

<div class="row mt-3">
    <div class="col" style="max-width: 40rem;">
        <div>
            <label for="formFile" class="form-label">Select Excel file to import</label>
            <InputFile @ref="InputFile" class="form-control form-control-sm" OnChange="LoadFileAsync" />
        </div>
    </div>
</div>

<div class="row align-items-center mt-3">
    <div class="col-auto">
        <HxButton Color="ThemeColor.Primary" Size="ButtonSize.Small" OnClick="UploadAsync" Enabled="Upload is not null">
            <CxIcon Icon="FeatherIcon.Save" />
            Save
        </HxButton>
    </div>
    <div class="col-auto ms-3">
        <label class="col-form-label">Upload type</label>
    </div>
    <div class="col-auto">
        <div>
            <select @bind="UploadType" class="form-select form-select-sm">
                @foreach (var type in UploadTypes)
                {
                    <option value="@type">@type</option>
                }
            </select>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col">
        <div class="card shadow-sm">
            <div class="card-body px-0">
                @if (Upload is not null)
                {
                    <small class="text-secondary px-3">@Upload.Data.Count record(s)</small>
                }
                <table class="table table-sm">
                    <thead>
                        <tr>
                            @foreach (var column in Builder?.Columns ?? Enumerable.Empty<string>())
                            {
                                <th>@column</th>
                            }
                        </tr>
                    </thead>
                    <tbody>
                        @if (Upload is null)
                        {
                            <tr>
                                <td colspan="@(Builder?.Columns.Count() ?? 1)" class="@(Loading ? "text-center" : null)">
                                    @if (Loading)
                                    {
                                        <HxSpinner Color="ThemeColor.Secondary" />
                                    }
                                    else
                                    {
                                        <em>Upload file to preview data</em>
                                    }
                                </td>
                            </tr>
                        }
                        else
                        {
                            <Virtualize Items="Upload.Data" Context="row" SpacerElement="tr"> 
                                <tr>
                                    @foreach (var column in Builder?.Columns ?? Enumerable.Empty<string>())
                                    {
                                        <td>@row[column]</td>
                                    }
                                </tr>
                            </Virtualize>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>


@code {
    [Parameter]
    public Guid? TableId { get; set; }

    private MasterDataTable? Table { get; set; }

    private InputFile? InputFile { get; set; }

    private bool Loading { get; set; } = false;

    private List<UploadType> UploadTypes { get; set; } = new();

    private UploadType UploadType { get; set; }

    private UploadBuilder? Builder { get; set; }

    private Upload? Upload { get; set; }

    protected override async Task OnParametersSetAsync()
    {
        using var context = await DbContextFactory.CreateDbContextAsync();
        Table = await context.MasterDataTables
            .Include(t => t.Category)
            .Include(t => t.Connection)
            .FirstAsync(t => t.DataTableId == TableId);

        // Protect users against an incorrect upload type selection by filtering them
        // based on what is allowed with the current data table.
        var uploadTypes = new List<UploadType>();
        if (Table.AllowInsert)
        {
            uploadTypes.Add(UploadType.Upsert);
            uploadTypes.Add(UploadType.InsertNew);
        }
        uploadTypes.Add(UploadType.UpdateExisting);
        if (Table.AllowDelete)
        {
            uploadTypes.Add(UploadType.DeleteMissing);
        }
        if (Table.AllowInsert && Table.AllowDelete)
        {
            uploadTypes.Add(UploadType.Full);
        }
        UploadTypes = uploadTypes;
        UploadType = UploadTypes.First();

        Builder = await UploadBuilder.FromTableAsync(Table);
    }

    private async Task LoadFileAsync(InputFileChangeEventArgs e)
    {
        Loading = true;
        try
        {
            ArgumentNullException.ThrowIfNull(Builder);
            using var stream = new MemoryStream();
            await e.File.OpenReadStream().CopyToAsync(stream);
            stream.Position = 0;
            Upload = Builder.BuildFromExcelStream(stream);
        }
        catch (Exception ex)
        {
            Messenger.AddError("Error reading Excel file", ex.Message);
        }
        finally
        {
            Loading = false;
        }
    }

    private async Task UploadAsync()
    {
        if (Upload is null)
        {
            Messenger.AddError("Upload object was null");
            return;
        }
        try
        {
            var (inserted, updated, deleted) = await Upload.SaveUploadToDbAsync(UploadType);
            var message = new StringBuilder();
            if (inserted == 0 && updated == 0 && deleted == 0)
            {
                message.Append("No changes detected");
            }
            if (inserted > 0)
            {
                message.Append("Inserted ").Append(inserted).Append(" record(s)").AppendLine();
            }
            if (updated > 0)
            {
                message.Append("Updated ").Append(updated).Append(" record(s)").AppendLine();
            }
            if (deleted > 0)
            {
                message.Append("Deleted ").Append(deleted).Append(" record(s)").AppendLine();
            }
            Messenger.AddInformation("Data updated successfully", message.ToString());
        }
        catch (Exception ex)
        {
            Messenger.AddError("Error updating data", ex.Message);
        }
    }
}
