@inject IHxMessengerService Messenger
@inject IHttpContextAccessor HttpContextAccessor
@inject IExecutorService ExecutorService
@inject IDbContextFactory<BiflowContext> DbContextFactory

<table class="table table-sm table-hover">
    <thead>
        <tr>
            @if (ShowDetailed)
            {
                <th>
                    Job
                </th>
            }
            <th>
                Step
            </th>
            <th>
                Execution phase
            </th>
            <th>
                Started
            </th>
            <th>
                Ended
            </th>
            <th>
                Duration
            </th>
            <th>
                Status
            </th>
        </tr>
    </thead>
    <tbody>
        @if (Executions is null)
        {
            <tr><td colspan="@(ShowDetailed ? 7 : 6)" class="text-center"><HxSpinner Color="ThemeColor.Secondary" Size="SpinnerSize.Small" /></td></tr>
        }
        else if (!Executions.Any())
        {
            <tr><td colspan="@(ShowDetailed ? 7 : 6)">No executions</td></tr>
        }
        else
        {
            <Virtualize TItem="StepExecutionProjection" Context="item" SpacerElement="tr" Items="Executions.ToList()" OverscanCount="20" ItemSize="34.2321f">
                <tr class="@(SelectedStepExecution == item ? "bg-body-tertiary" : null)" style="cursor: pointer;" @onclick="async () => await ToggleSelectedStepExecutionAsync(item)">
                    @if (ShowDetailed)
                    {
                        <td>
                            @item.JobName
                        </td>
                    }
                    <td>
                        <StepTypeIconComponent StepType_="item.StepType" />
                        &nbsp;
                        @item.StepName
                    </td>
                    <td class="@(item.DependencyMode ? "text-body-tertiary" : "text-body")" style="">
                        @item.ExecutionPhase
                        &nbsp;
                        <CxIcon Icon="FeatherIcon.Layers" />
                    </td>
                    <td>
                        @item.StartDateTime?.LocalDateTime
                    </td>
                    <td>
                        @item.EndDateTime?.LocalDateTime
                    </td>
                    <td>
                        <text>@item.ExecutionInSeconds?.SecondsToReadableFormat()</text>
                    </td>
                    <td>
                        <StepExecutionStatusBadgeComponent ExecutionStatus="@item.ExecutionStatus" />
                    </td>
                </tr>
                @if (SelectedStepExecution == item)
                {
                    if (DetailStep is null)
                    {
                        <tr>
                            <td colspan="7" class="text-center">
                                <HxSpinner Color="ThemeColor.Secondary" Size="SpinnerSize.Small" />
                            </td>
                        </tr>
                    }
                    else
                    {
                        <tr class="table-borderless no-hover bg-body-tertiary">
                            <td colspan="7">
                                <HxButtonToolbar CssClass="mb-3 mt-1 ms-2">
                                    <HxButton Size="ButtonSize.Small" Color="ThemeColor.None" CssClass="btn-auto" @onclick="async () => await StepHistoryOffcanvas.LetAsync(x => x.ShowAsync(DetailStep.StepId))">
                                        <CxIcon Icon="LucideIcon.History" />
                                        History
                                    </HxButton>
                                    <AuthorizeView Roles="Admin, Editor, Operator">
                                        @if (DetailStep.CanBeStopped)
                                        {
                                            <HxDropdownButtonGroup CssClass="ms-3">
                                                <HxDropdownToggleButton Size="ButtonSize.Small" Color="ThemeColor.None" CssClass="btn-auto text-danger">
                                                    <CxIcon Icon="FeatherIcon.XOctagon" />
                                                    Stop
                                                </HxDropdownToggleButton>
                                                <HxDropdownMenu>
                                                    <HxDropdownItem @onclick="async () => await StopStepExecutionAsync(DetailStep)">Confirm</HxDropdownItem>
                                                </HxDropdownMenu>
                                            </HxDropdownButtonGroup>
                                        }
                                    </AuthorizeView>
                                </HxButtonToolbar>

                                <StepExecutionDetailsComponent StepExecutionAttempt="DetailStep" />
                            </td>
                        </tr>
                    }
                }
            </Virtualize>
        }
    </tbody>
</table>

<StepHistoryOffcanvas @ref="StepHistoryOffcanvas" />

@code {
    [Parameter]
    public IEnumerable<StepExecutionProjection>? Executions { get; set; }

    [Parameter]
    public bool ShowDetailed { get; set; } = true;

    [Parameter]
    public Func<StepExecutionProjection, StepExecutionAttempt?>? DetailStepProvider { get; set; }

    private StepExecutionProjection? SelectedStepExecution { get; set; }

    private StepHistoryOffcanvas? StepHistoryOffcanvas { get; set; }

    private StepExecutionAttempt? DetailStep { get; set; }

    private async Task ToggleSelectedStepExecutionAsync(StepExecutionProjection execution)
    {
        // If the selected execution is the same that was previously selected, set to null
        // => hides step execution details component.
        if (SelectedStepExecution == execution)
        {
            SelectedStepExecution = null;
            DetailStep = null;
        }
        else
        {
            SelectedStepExecution = execution;

            if (DetailStepProvider is not null)
            {
                DetailStep = DetailStepProvider(execution);
            }
            else
            {
                using var context = await DbContextFactory.CreateDbContextAsync();
                DetailStep = await context.StepExecutionAttempts
                    .AsNoTrackingWithIdentityResolution()
                    .Include($"{nameof(StepExecutionAttempt.StepExecution)}.{nameof(IHasStepExecutionParameters.StepExecutionParameters)}.{nameof(StepExecutionParameterBase.InheritFromExecutionParameter)}")
                    .Include($"{nameof(StepExecutionAttempt.StepExecution)}.{nameof(IHasStepExecutionParameters.StepExecutionParameters)}.{nameof(StepExecutionParameterBase.ExpressionParameters)}")
                    .Include(e => e.StepExecution)
                    .ThenInclude(e => e.Execution)
                    .ThenInclude(e => e.ExecutionParameters)
                    .Include(e => e.StepExecution)
                    .ThenInclude(e => e.ExecutionConditionParameters)
                    .ThenInclude(e => e.ExecutionParameter)
                    .Include(e => e.StepExecution)
                    .ThenInclude(e => e.Step)
                    .FirstOrDefaultAsync(e => e.ExecutionId == execution.ExecutionId && e.StepId == execution.StepId && e.RetryAttemptIndex == execution.RetryAttemptIndex);
            }   
        }
        StateHasChanged();
    }

    private async Task StopStepExecutionAsync(StepExecutionAttempt stepExecution)
    {
        try
        {
            string username = HttpContextAccessor.HttpContext?.User?.Identity?.Name
                ?? throw new ArgumentNullException(nameof(username), "Error getting username from HttpContext");
            await ExecutorService.StopExecutionAsync(stepExecution.ExecutionId, stepExecution.StepId, username);
            if (stepExecution.ExecutionStatus == StepExecutionStatus.NotStarted)
            {
                Messenger.AddInformation("Stop request sent successfully to the executor service. The step will be stopped once it reaches the 'Queued' status.");
            }
            else
            {
                Messenger.AddInformation("Stop request sent successfully to the executor service");
            }
        }
        catch (TimeoutException)
        {
            Messenger.AddError("Operation timed out", "The executor process may no longer be running");
        }
        catch (Exception ex)
        {
            Messenger.AddError("Error stopping execution", ex.Message);
        }
    }
}
