@using BlazorMonaco.Editor

@implements IDisposable

@inject ThemeService ThemeService
@inject IJSRuntime JS

@{
    var resize = Resize switch
    {
        CodeEditorResize.Horizontal => "horizontal",
        CodeEditorResize.Both => "both",
        _ => "vertical"
    };
}

<style>
    @($"#{editorId} {{ height: {InitialHeight}; resize: {resize}; overflow: hidden; }}")
</style>

<StandaloneCodeEditor @ref="editor"
                      Id="@editorId"
                      ConstructionOptions="GetEditorOptions"
                      OnDidChangeModelContent="OnDidChangeModelContent"
                      CssClass="border" />

@code {
    /// <summary>
    /// Initial editor height in css. Default is "100px".
    /// </summary>
    [Parameter] public string InitialHeight { get; set; } = "100px";

    [Parameter, EditorRequired] public string? Language { get; set; }

    [Parameter] public EventCallback<string?> OnValueChanged { get; set; }

    [Parameter] public Func<string?> InitialValueExpression { get; set; } = () => "";

    [Parameter] public bool MinimapEnabled { get; set; } = true;

    [Parameter] public bool ReadOnly { get; set; } = false;

    [Parameter] public CodeEditorResize Resize { get; set; } = CodeEditorResize.Vertical;

    private StandaloneCodeEditor? editor { get; set; }
    private readonly string editorId = $"_{Guid.NewGuid().ToString()}"; // prefix with underscode as html id cannot start with a number

    public enum CodeEditorResize { Vertical, Horizontal, Both }

    public Task SetValueAsync(string? value)
    {
        ArgumentNullException.ThrowIfNull(editor);
        return editor.SetValue(value);
    }

    public async Task<string?> GetValueAsync()
    {
        ArgumentNullException.ThrowIfNull(editor);
        var model = await editor.GetModel();
        var value = await model.GetValue(EndOfLinePreference.TextDefined, false);
        return value;
    }

    public async Task SetLanguageAsync(string language)
    {
        ArgumentNullException.ThrowIfNull(editor);
        var value = await GetValueAsync();
        var model = await Global.CreateModel(JS, value, language);
        await editor.SetModel(model);
    }

    protected override void OnInitialized()
    {
        ThemeService.OnThemeChanged += OnThemeChanged;
        var darkTheme = new StandaloneThemeData
        {
            Base = "vs-dark",
            Inherit = true,
            Rules = new(),
            Colors = new Dictionary<string, string>
            {
                { "editor.background", "#212529" }
            }
        };
        Global.DefineTheme(JS, "custom-dark", darkTheme);
    }

    private StandaloneEditorConstructionOptions GetEditorOptions(StandaloneCodeEditor editor) => new()
    {
        AutomaticLayout = true,
        Language = Language,
        Value = InitialValueExpression(),
        ReadOnly = ReadOnly,
        Minimap = new EditorMinimapOptions { Enabled = MinimapEnabled },
        Theme = ThemeService.CurrentTheme == Theme.Dark ? "custom-dark" : "vs"
    };

    private void OnThemeChanged(Theme theme, bool isAuto)
    {
        var options = new EditorUpdateOptions
        {
            Theme = theme == Theme.Dark ? "vs-dark" : "vs"
        };
        editor?.UpdateOptions(options);
    }

    private async Task OnDidChangeModelContent(ModelContentChangedEvent e)
    {
        var value = await GetValueAsync();
        await OnValueChanged.InvokeAsync(value);
    }

    public void Dispose()
    {
        ThemeService.OnThemeChanged -= OnThemeChanged;
    }
}
