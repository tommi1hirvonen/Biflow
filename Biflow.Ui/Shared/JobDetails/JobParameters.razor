<PageTitle>@Job?.JobName | Parameters | Biflow</PageTitle>

@if (editJob is null || Steps is null)
{
    <div class="row mt-3">
        <div class="col text-center">
            <HxSpinner Color="ThemeColor.Secondary" />
        </div>
    </div>
}
else
{
    <NavigationLock ConfirmExternalNavigation OnBeforeInternalNavigation="OnBeforeInternalNavigation" />

    <div class="row">
        <div class="col">
            <HxButtonToolbar>
                <HxSubmit form="job_parameter_form" Color="ThemeColor.Success">
                    <SvgIcon Icon="FeatherIcon.Save" />
                    Save
                </HxSubmit>
                <HxButton Color="ThemeColor.Secondary" CssClass="ms-3" @onclick="AddParameter">
                    <SvgIcon Icon="FeatherIcon.Plus" />
                    Add parameter
                </HxButton>
            </HxButtonToolbar>
        </div>
        <div class="col text-end">
            <HxPopover Placement="PopoverPlacement.Bottom" Trigger="PopoverTrigger.Focus"
                        Content="@("<p>Job parameters can be passed to steps that support parameterization.</p><p>Use job parameters to define common parameters across all steps.</p><p>SQL steps can even edit job parameter values during execution.</p>")"
                Html>
                <HxButton Color="ThemeColor.None" Size="ButtonSize.Small" CssClass="btn-auto">
                    <SvgIcon Icon="FeatherIcon.HelpCircle" />
                </HxButton>
            </HxPopover>
        </div>
    </div>
    
    <div class="row my-4">
        <div class="col">
            <div class="card shadow-sm">
                <EditForm EditContext="editContext" id="job_parameter_form" OnValidSubmit="SubmitParameters">
                    <ObjectGraphDataAnnotationsValidator />
                    <ValidationSummary />
                    <FluentValidationValidator @ref="fluentJobValidator" Validator="JobValidator" />
                    <table id="parameters_table" class="table">
                        <thead>
                            <tr>
                                <th>
                                    Name
                                </th>
                                <th>
                                    
                                </th>
                                <th>
                                    
                                </th>
                                <th>
                                    References
                                </th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (!editJob?.JobParameters?.Any() ?? true)
                            {
                                <tr><td colspan="5">No parameters</td></tr>
                            }
                            @foreach (var param in editJob?.JobParameters ?? Enumerable.Empty<JobParameter>())
                            {
                                var referenceCount = GetInheritingSteps(param)
                                    .Concat(GetCapturingSteps(param))
                                    .Concat(GetAssigningSteps(param))
                                    .Concat(GetExecutionConditionSteps(param))
                                    .Count();
                                <tr>
                                    <td>
                                        <InputText class="form-control form-control-sm"
                                                   @bind-Value="param.ParameterName"
                                                   placeholder="Name"
                                                   @bind-Value:after="() => fluentJobValidator.LetAsync(x => x.ValidateAsync())" />
                                    </td>
                                    <DynamicParameterEditor Parameter="param"
                                                            TParameter="JobParameter"
                                                            OnParameterEdit="p => expressionEditOffcanvas.LetAsync(x => x.ShowAsync(p))">
                                        <StaticEditTemplate>
                                            <ParameterTypeValueEditor Parameter="param" />
                                        </StaticEditTemplate>
                                    </DynamicParameterEditor>
                                    <td>
                                        @if (referenceCount > 0)
                                        {
                                            <a class="text-body" href="javascript:void()" @onclick="() => ShowReferencingStepsAsync(param)">
                                                @referenceCount step(s)
                                            </a>
                                        }
                                    </td>
                                    <td>
                                        <HxButtonGroup Size="ButtonGroupSize.Small">
                                            <HxButton Color="ThemeColor.None" Size="ButtonSize.Small" CssClass="btn-auto" @onclick="() => RemoveParameter(param)">
                                                <SvgIcon Icon="FeatherIcon.Delete" />
                                            </HxButton>
                                        </HxButtonGroup>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </EditForm>
            </div>
        </div>
    </div>
}

<ExpressionEditOffcanvas @ref="expressionEditOffcanvas" TParameter="JobParameter" OnExpressionChanged="StateHasChanged">
    <div class="row mt-3">
        <div class="col text-secondary small">
            Job parameter expressions have the following built-in variables automatically available. They can be used to access the internal ids during execution.
            <ul>
                <li><span class="font-monospace text-secondary-emphasis">@ExpressionParameterNames.ExecutionId</span> - The current execution id. An empty guid is passed when the expression is being tested.</li>
                <li><span class="font-monospace text-secondary-emphasis">@ExpressionParameterNames.JobId</span> - The id of the current job.</li>
            </ul>
        </div>
    </div>
</ExpressionEditOffcanvas>

<HxOffcanvas @ref="referencingStepsOffcanvas" Title="@($"Steps referencing {referencingSteps.Parameter.ParameterName}")" Backdrop="OffcanvasBackdrop.False">
    <BodyTemplate>
        <h6>
            Inheriting steps
            <HxPopover Content="Steps in this job that have parameters whose value is inheriting the job parameter value"
                       Trigger="PopoverTrigger.Hover">
                <SvgIcon Icon="FeatherIcon.Info" />
            </HxPopover>
        </h6>
        <table class="table table-sm">
            <thead>
                <tr>
                    <th>
                        Step
                    </th>
                </tr>
            </thead>
            <tbody>
                @if (!referencingSteps.InheritingSteps.Any())
                {
                    <tr><td class="text-muted">No inheriting steps</td></tr>
                }
                else
                {
                    foreach (var step in referencingSteps.InheritingSteps)
                    {
                        <tr>
                            <td>
                                <StepTypeIcon StepType="step.StepType" />
                                @step.StepName
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>

        <h6 class="mt-5">
            Capturing steps
            <HxPopover Content="Steps in this job that are capturing their return value and saving it to the job parameter"
                       Trigger="PopoverTrigger.Hover">
                <SvgIcon Icon="FeatherIcon.Info" />
            </HxPopover>
        </h6>
        <table class="table table-sm">
            <thead>
                <tr>
                    <th>
                        Step
                    </th>
                </tr>
            </thead>
            <tbody>
                @if (!referencingSteps.CapturingSteps.Any())
                {
                    <tr><td class="text-muted">No capturing steps</td></tr>
                }
                else
                {
                    foreach (var step in referencingSteps.CapturingSteps)
                    {
                        <tr>
                            <td>
                                <StepTypeIcon StepType="step.StepType" />
                                @step.StepName
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>

        <h6 class="mt-5">
            Assigning steps
            <HxPopover Content="Steps in other jobs that are launching this job and assigning values to the job parameter"
                       Trigger="PopoverTrigger.Hover">
                <SvgIcon Icon="FeatherIcon.Info" />
            </HxPopover>
        </h6>
        <table class="table table-sm">
            <thead>
                <tr>
                    <th>
                        Job
                    </th>
                    <th>
                        Step
                    </th>
                </tr>
            </thead>
            <tbody>
                @if (!referencingSteps.AssigningSteps.Any())
                {
                    <tr><td class="text-muted" colspan="2">No assigning steps</td></tr>
                }
                else
                {
                    foreach (var step in referencingSteps.AssigningSteps)
                    {
                        <tr>
                            <td>
                                @step.Job.JobName
                            </td>
                            <td>
                                <StepTypeIcon StepType="step.StepType" />
                                @step.StepName
                            </td>
                        </tr>
                    }
                }
                
            </tbody>
        </table>

        <h6 class="mt-5">
            Execution conditions
            <HxPopover Content="Steps whose execution condition parameters are referencing this job parameter"
                       Trigger="PopoverTrigger.Hover">
                <SvgIcon Icon="FeatherIcon.Info" />
            </HxPopover>
        </h6>
        <table class="table table-sm">
            <thead>
                <tr>
                    <th>
                        Step
                    </th>
                </tr>
            </thead>
            <tbody>
                @if (!referencingSteps.ExecutionConditionSteps.Any())
                {
                    <tr><td class="text-muted" colspan="2">No execution conditions</td></tr>
                }
                else
                {
                    foreach (var step in referencingSteps.ExecutionConditionSteps)
                    {
                        <tr>
                            <td>
                                <StepTypeIcon StepType="step.StepType" />
                                @step.StepName
                            </td>
                        </tr>
                    }
                }

            </tbody>
        </table>
    </BodyTemplate>
    <FooterTemplate>
        <HxButton Color="ThemeColor.Secondary" OnClick="() => referencingStepsOffcanvas.LetAsync(x => x.HideAsync())" Spinner="false">
            Close
        </HxButton>
    </FooterTemplate>
</HxOffcanvas>