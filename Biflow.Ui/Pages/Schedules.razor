@page "/schedules/{Component?}"

@inject IDbContextFactory<BiflowContext> DbFactory
@inject IHxMessengerService Messenger
@inject ISchedulerService SchedulerService

<style>
    tr a {
        text-decoration: none;
    }

        tr a:hover {
            text-decoration: underline;
        }

    .white-space-pre {
        white-space: pre;
    }
</style>

<PageTitle>Schedules | Biflow</PageTitle>

<h4>Schedules</h4>

<div class="row mt-3 mb-4">
    <div class="col">
        <ul class="nav nav-tabs" role="tablist">
            <li class="nav-item" role="presentation">
                <NavLink class="nav-link" Match="NavLinkMatch.All" href="@($"schedules")">
                    <CxIcon Icon="FeatherIcon.List" />
                    List
                </NavLink>
            </li>
            <li class="nav-item" role="presentation">
                <NavLink class="nav-link" Match="NavLinkMatch.All" href="@($"schedules/graph")">
                    <CxIcon Icon="LucideIcon.BarChartHorizontal" />
                    Graph
                </NavLink>
            </li>
        </ul>
    </div>
</div>

@if (Component is null)
{
    <SchedulesListComponent Schedules="Schedules_" Jobs="Jobs" />
}
else if (Component == "graph")
{
    <SchedulesGraphComponent Schedules="Schedules_" />
}
else
{
    <p>No component to display with component parameter @Component</p>
}

@code {
    [Parameter] public string? Component { get; set; }

    private List<Job>? Jobs { get; set; }

    private List<Schedule>? Schedules_ { get; set; }

    protected override async Task OnInitializedAsync()
    {
        using var context = await Task.Run(DbFactory.CreateDbContext);
        Jobs = await context.Jobs.OrderBy(job => job.JobName).ToListAsync();
        Schedules_ = await context.Schedules
            .AsNoTrackingWithIdentityResolution()
            .Include(schedule => schedule.Job)
            .Include(schedule => schedule.Tags)
            .OrderBy(schedule => schedule.Job.JobName)
            .ThenBy(schedule => schedule.ScheduleName)
            .ToListAsync();
    }

}
