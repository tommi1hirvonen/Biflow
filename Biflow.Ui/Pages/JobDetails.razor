
@*Increase dropdown menu z-index so that it is displayed over the sticky-top div in StepsComponent.*@
<style>
    .dropdown-menu {
        z-index: 1100;
    }
</style>

<div class="row align-items-center gap-3">
    <div class="col-auto">
        <div>
            <a href="jobs">
                All jobs
            </a>
            <span>&nbsp;/&nbsp;</span>
            @if (Job?.Category is not null)
            {
                <span>@Job.Category.CategoryName /&nbsp;</span>
            }
            <strong>@Job?.JobName</strong>
        </div>
    </div>
    @if (!string.IsNullOrWhiteSpace(Job?.JobDescription))
    {
        <div class="col-auto">
            <HxButton Color="ThemeColor.None"
                      CssClass="btn-auto"
                      Size="ButtonSize.Small"
                      @onclick="() => DescriptionOpen = !DescriptionOpen">
                <CxIcon Icon="FeatherIcon.Info" />
                &nbsp;
                @if (DescriptionOpen)
                {
                    <span>Hide description</span>
                }
                else
                {
                    <span>Show description</span>
                }
            </HxButton>
        </div>
    }

    <div class="col-xl d-flex flex-row flex-xl-row-reverse justify-content-xl-start align-items-center">
        <AuthorizeView Roles="@($"{Roles.Admin}, {Roles.Editor}")">
            <div class="ms-0 ms-xl-4 me-4 me-xl-0">
                @*Dropdown to delete the current job*@
                <HxDropdownButtonGroup CssClass="ms-3">
                    <HxDropdownToggleButton Color="ThemeColor.None" Size="ButtonSize.Small" CssClass="btn-auto text-danger">
                        <CxIcon Icon="FeatherIcon.Trash2" />
                        Delete
                    </HxDropdownToggleButton>
                    <HxDropdownMenu CssClass="dropdown-menu-xl-right">
                        <HxDropdownHeader>Delete job?</HxDropdownHeader>
                        <HxDropdownItem @onclick="DeleteJob">Confirm</HxDropdownItem>
                    </HxDropdownMenu>
                </HxDropdownButtonGroup>
            </div>
        </AuthorizeView>

        <AuthorizeView Roles="@($"{Roles.Admin}, {Roles.Editor}")">
            <div class="form-check form-switch">
                <input type="checkbox" class="form-check-input" id="job_enabled_toggle" checked="@(Job?.IsEnabled ?? false ? "checked" : null)" @onchange="ToggleJobEnabled">
                <label class="form-check-label" for="job_enabled_toggle">Enabled</label>
            </div>
        </AuthorizeView>

        <AuthorizeView Roles="@($"{Roles.Operator}, {Roles.Viewer}")">
            <div class="form-check form-switch">
                <input type="checkbox" class="form-check-input" disabled id="job_enabled_toggle" checked="@(Job?.IsEnabled ?? false ? "checked" : null)">
                <label class="form-check-label" for="job_enabled_toggle">Enabled</label>
            </div>
        </AuthorizeView>
    </div>
</div>

@if (DescriptionOpen && !string.IsNullOrWhiteSpace(Job?.JobDescription))
{
    <div class="row mt-3">
        <div class="col-auto border rounded" style="max-height: 110px; overflow-y: auto;">
            <small class="text-secondary" style="white-space: pre-line;">@Job?.JobDescription</small>
        </div>
    </div>
}

@if (Job is not null)
{
    <div class="row mt-3">
        @if (!Job.IsEnabled)
        {
            <div class="col-auto">
                <div class="alert alert-warning mb-0" role="alert">
                    Job is disabled — scheduled executions of this job will not be started
                </div>
            </div>
        }
    </div>
}

<div class="row mt-3 mb-4">
    <div class="col">
        <ul class="nav nav-tabs nav-fill" role="tablist">
            <li class="nav-item" role="presentation">
                <NavLink class="nav-link" href="@($"jobs/{Job?.JobId}/steps")">
                    <CxIcon Icon="LucideIcon.ListChecks" />
                    Steps
                </NavLink>
            </li>
            <AuthorizeView Roles="@($"{Roles.Admin}, {Roles.Editor}, {Roles.Operator}")">
                <li class="nav-item" role="presentation">
                    <NavLink class="nav-link" href="@($"jobs/{Job?.JobId}/parameters")">
                        <CxIcon Icon="FeatherIcon.AtSign" />
                        Parameters
                    </NavLink>
                </li>
            </AuthorizeView>
            <li class="nav-item" role="presentation">
                <NavLink class="nav-link" href="@($"jobs/{Job?.JobId}/dependencies")">
                    <CxIcon Icon="LucideIcon.Network" />
                    Dependencies
                </NavLink>
            </li>
            <li class="nav-item" role="presentation">
                <NavLink class="nav-link" href="@($"jobs/{Job?.JobId}/schedules")">
                    <CxIcon Icon="FeatherIcon.Calendar" />
                    Schedules
                </NavLink>
            </li>
            <li class="nav-item" role="presentation">
                <NavLink class="nav-link" href="@($"jobs/{Job?.JobId}/history")">
                    <CxIcon Icon="LucideIcon.History" />
                    History
                </NavLink>
            </li>
            <AuthorizeView Roles="@($"{Roles.Admin}, {Roles.Editor}")">
                <li class="nav-item" role="presentation">
                    <NavLink class="nav-link" href="@($"jobs/{Job?.JobId}/settings")">
                        <CxIcon Icon="LucideIcon.Settings2" />
                        Settings
                    </NavLink>
                </li>
            </AuthorizeView>
        </ul>
    </div>    
</div>

<CascadingValue Value="Job">
    <CascadingValue Value="Steps" IsFixed>
        <CascadingValue Value="Jobs" IsFixed>
            <CascadingValue Value="OnJobUpdated" Name="OnJobUpdated" IsFixed>
                <CascadingValue Value="SortSteps" Name="SortSteps" IsFixed>

                    @* Leave steps component rendered but only update the visibility css class. This way rendering is quicker when returning to the component. *@
                    <div class="@(DetailsPage == "steps" ? null : "d-none")">
                        <StepsComponent SqlConnections="SqlConnections"
                                        AsConnections="AsConnections"
                                        PipelineClients="PipelineClients"
                                        AppRegistrations="AppRegistrations"
                                        FunctionApps="FunctionApps"
                                        QlikCloudClients="QlikCloudClients"
                                        InitialStepId="@(DetailsPage == "steps" ? InitialStepId : null)" />
                    </div>

                    @if (DetailsPage == "parameters")
                    {
                        <AuthorizeView Roles="@($"{Roles.Admin}, {Roles.Editor}, {Roles.Operator}")">
                            <JobParametersComponent />
                        </AuthorizeView>
                    }
                    else if (DetailsPage == "history" && Job is not null)
                    {
                        <JobHistoryComponent JobId="Job.JobId" JobName="Job.JobName" />
                    }
                    else if (DetailsPage == "dependencies")
                    {
                        <DependenciesComponent SqlConnections="SqlConnections"
                                               AsConnections="AsConnections"
                                               PipelineClients="PipelineClients"
                                               AppRegistrations="AppRegistrations"
                                               FunctionApps="FunctionApps"
                                               InitialStepId="InitialStepId"
                                               QlikCloudClients="QlikCloudClients" />
                    }
                    else if (DetailsPage == "schedules")
                    {
                        <SchedulesComponent />
                    }
                    else if (DetailsPage == "settings")
                    {
                        <AuthorizeView Roles="@($"{Roles.Admin}, {Roles.Editor}")">
                            <JobSettingsComponent />
                        </AuthorizeView>
                    }
                </CascadingValue>
            </CascadingValue>
        </CascadingValue>
    </CascadingValue>
</CascadingValue>