
<PageTitle>Executions | Biflow</PageTitle>

<h4>Executions</h4>

@if (!sessionStorageRetrieved) return;

<div class="row mt-3">
    <div class="col">
        <HxButtonToolbar>
            <HxButtonGroup Size="ButtonGroupSize.Small">
                <HxButton Size="ButtonSize.Small" Color="ThemeColor.Secondary"
                @onclick="ShowExecutionsAsync"
                Spinner="false"
                CssClass="@(!showSteps ? "active" : null)">
                    <CxIcon Icon="LucideIcon.ClipboardList" />
                    Jobs
                </HxButton>
                <HxButton Size="ButtonSize.Small" Color="ThemeColor.Secondary"
                @onclick="ShowStepExecutionsAsync"
                Spinner="false"
                CssClass="@(showSteps ? "active" : null)">
                    <CxIcon Icon="LucideIcon.ListChecks" />
                    Steps
                </HxButton>
            </HxButtonGroup>
            <HxButtonGroup Size="ButtonGroupSize.Small" CssClass="ms-3">
                <HxButton Size="ButtonSize.Small" Color="ThemeColor.Secondary"
                @onclick="() => showGraph = false"
                Spinner="false"
                CssClass="@(!showGraph ? "active" : null)">
                    <CxIcon Icon="FeatherIcon.List" />
                    List
                </HxButton>
                <HxButton Size="ButtonSize.Small" Color="ThemeColor.Secondary"
                @onclick="() => showGraph = true"
                Spinner="false"
                CssClass="@(showGraph ? "active" : null)">
                    <CxIcon Icon="LucideIcon.BarChartHorizontal" />
                    Gantt
                </HxButton>
            </HxButtonGroup>
            <HxDropdownButtonGroup CssClass="ms-3">
                <HxDropdownToggleButton Size="ButtonSize.Small" Color="ThemeColor.Secondary" Enabled="!loading">
                    <CxIcon Icon="FeatherIcon.Bookmark" />
                    Presets
                </HxDropdownToggleButton>
                <HxDropdownMenu>
                    <HxDropdownHeader>Last</HxDropdownHeader>
                    <HxDropdownItem CssClass="@(activePreset == Preset.OneHour ? "active" : null)" @onclick="() => ApplyPresetAsync(Preset.OneHour)">1 h</HxDropdownItem>
                    <HxDropdownItem CssClass="@(activePreset == Preset.ThreeHours ? "active" : null)" @onclick="() => ApplyPresetAsync(Preset.ThreeHours)">3 h</HxDropdownItem>
                    <HxDropdownItem CssClass="@(activePreset == Preset.TwelveHours ? "active" : null)" @onclick="() => ApplyPresetAsync(Preset.TwelveHours)">12 h</HxDropdownItem>
                    <HxDropdownItem CssClass="@(activePreset == Preset.TwentyFourHours ? "active" : null)" @onclick="() => ApplyPresetAsync(Preset.TwentyFourHours)">24 h</HxDropdownItem>
                    <HxDropdownItem CssClass="@(activePreset == Preset.ThreeDays ? "active" : null)" @onclick="() => ApplyPresetAsync(Preset.ThreeDays)">3 d</HxDropdownItem>
                    <HxDropdownItem CssClass="@(activePreset == Preset.SevenDays ? "active" : null)" @onclick="() => ApplyPresetAsync(Preset.SevenDays)">7 d</HxDropdownItem>
                    <HxDropdownItem CssClass="@(activePreset == Preset.FourteenDays ? "active" : null)" @onclick="() => ApplyPresetAsync(Preset.FourteenDays)">14 d</HxDropdownItem>
                    <HxDropdownItem CssClass="@(activePreset == Preset.ThirtyDays ? "active" : null)" @onclick="() => ApplyPresetAsync(Preset.ThirtyDays)">30 d</HxDropdownItem>
                    <HxDropdownDivider></HxDropdownDivider>
                    <HxDropdownHeader>This</HxDropdownHeader>
                    <HxDropdownItem CssClass="@(activePreset == Preset.ThisDay ? "active" : null)" @onclick="() => ApplyPresetAsync(Preset.ThisDay)">Day</HxDropdownItem>
                    <HxDropdownItem CssClass="@(activePreset == Preset.ThisWeek ? "active" : null)" @onclick="() => ApplyPresetAsync(Preset.ThisWeek)">Week</HxDropdownItem>
                    <HxDropdownItem CssClass="@(activePreset == Preset.ThisMonth ? "active" : null)" @onclick="() => ApplyPresetAsync(Preset.ThisMonth)">Month</HxDropdownItem>
                    <HxDropdownDivider></HxDropdownDivider>
                    <HxDropdownHeader>Previous</HxDropdownHeader>
                    <HxDropdownItem CssClass="@(activePreset == Preset.PreviousDay ? "active" : null)" @onclick="() => ApplyPresetAsync(Preset.PreviousDay)">Day</HxDropdownItem>
                    <HxDropdownItem CssClass="@(activePreset == Preset.PreviousWeek ? "active" : null)" @onclick="() => ApplyPresetAsync(Preset.PreviousWeek)">Week</HxDropdownItem>
                    <HxDropdownItem CssClass="@(activePreset == Preset.PreviousMonth ? "active" : null)" @onclick="() => ApplyPresetAsync(Preset.PreviousMonth)">Month</HxDropdownItem>
                </HxDropdownMenu>
            </HxDropdownButtonGroup>

            <HxSubmit FormId="executions_form" Size="ButtonSize.Small" Color="ThemeColor.Primary" Spinner="loading" Enabled="!loading" CssClass="ms-3">
                <CxIcon Icon="FeatherIcon.RefreshCw" />
                Refresh
            </HxSubmit>
        </HxButtonToolbar>
    </div>
</div>

<div class="row mt-3">
    <div class="col">
        <form class="d-inline-flex align-items-center" id="executions_form" @onsubmit="LoadDataAsync" style="flex-direction: unset !important;">
            <label class="me-3">From</label>
            <div class="input-group">
                <div class="input-group-text">
                    <CxIcon Icon="FeatherIcon.Calendar" />
                </div>
                <input @bind="FromDateTime"
                       @bind:format="yyyy-MM-ddTHH:mm:ss"
                       @bind:after="() => activePreset = null"
                       class="form-control form-control-sm"
                       type="datetime-local">
            </div>
            <label class="mx-3">To</label>
            <div class="input-group">
                <div class="input-group-text">
                    <CxIcon Icon="FeatherIcon.Calendar" />
                </div>
                <input @bind="ToDateTime"
                       @bind:format="yyyy-MM-ddTHH:mm:ss"
                       @bind:after="() => activePreset = null"
                       class="form-control form-control-sm"
                       type="datetime-local">
            </div>
        </form>
    </div>
</div>

<div class="row mt-3">
    <div class="col-auto d-inline">
        <CxIcon Icon="FeatherIcon.Filter" />
        <span class="me-3">Filters</span>

        <HxButtonGroup Size="ButtonGroupSize.Small">
            @{
                IEnumerable<string>? jobNames = showSteps switch
                {
                    true => stepExecutions?
                        .Where(e => startTypeFilter == StartType.All ||
                        startTypeFilter == StartType.Scheduled && e.ScheduleId is not null ||
                        startTypeFilter == StartType.Manual && e.ScheduleId is null) // Limit visible jobs based on start type filter
                        .Where(e => !stepFilter.Any() || stepFilter.Contains((e.StepName, e.StepType))) // Limit visible jobs based on step filter
                        .Where(e => !stepTypeFilter.Any() || stepTypeFilter.Contains(e.StepType)) // Limit visible jobs based on step type filter
                        //.Where(e => !TagFilter.Any() || e.Tags.Any(t => TagFilter.Contains(t.TagName)) == true) // Limit visible jobs based on tag filter
                        .Where(e => !stepStatusFilter.Any() || stepStatusFilter.Contains(e.ExecutionStatus)) // Limit visible jobs based on step status filter
                        .Select(e => e.JobName),
                    false => executions?
                        .Where(e => startTypeFilter == StartType.All ||
                        startTypeFilter == StartType.Scheduled && e.ScheduleId is not null ||
                        startTypeFilter == StartType.Manual && e.ScheduleId is null) // Limit visible jobs based on start type filter
                        .Where(e => !jobStatusFilter.Any() || jobStatusFilter.Contains(e.ExecutionStatus)) // Limit visible jobs based on job status filter
                        .Select(e => e.JobName)
                };
                jobNames = jobNames?.Distinct().OrderBy(j => j) ?? Enumerable.Empty<string>();
            }
            <FilterDropdown TItem="string"
                            FilterSet="jobFilter"
                            Items="jobNames"
                            OnChange="StateHasChanged">
                <TitleTemplate>
                    <CxIcon Icon="LucideIcon.ClipboardList" />
                    Job
                </TitleTemplate>
            </FilterDropdown>

            @if (showSteps)
            {
                <FilterDropdown TItem="(string StepName, StepType StepType)"
                                FilterSet="stepFilter"
                                Items="stepExecutions?
                                   .Where(e => startTypeFilter == StartType.All ||
                                    startTypeFilter == StartType.Scheduled && e.ScheduleId is not null ||
                                    startTypeFilter == StartType.Manual && e.ScheduleId is null) // Limit visible steps based on start type filter
                                   .Where(e => !jobFilter.Any() || jobFilter.Contains(e.JobName)) // Limit visible steps based on job filter
                                   //.Where(s => !TagFilter.Any() || s.Tags.Any(t => TagFilter.Contains(t.TagName)) == true) // Limit visible steps based on tag filter
                                   .Where(s => !stepStatusFilter.Any() || stepStatusFilter.Contains(s.ExecutionStatus)) // Limit visible steps based on step status filter
                                   .Where(s => !stepTypeFilter.Any() || stepTypeFilter.Contains(s.StepType)) // Limit visible steps based on step type filter
                                   .Select(s => (s.StepName, s.StepType))
                                   .Distinct()
                                   .OrderBy(j => j) ?? Enumerable.Empty<(string, StepType)>()"
                                OnChange="StateHasChanged"
                                IsSearchable="true">
                    <TitleTemplate>
                        <CxIcon Icon="LucideIcon.ListChecks" />
                        Step
                    </TitleTemplate>
                    <ItemTemplate Context="item">
                        <StepTypeIconComponent StepType="item.StepType" />
                        @item.StepName
                    </ItemTemplate>
                </FilterDropdown>
                <FilterDropdown TItem="StepType"
                                FilterSet="stepTypeFilter"
                                Items="stepExecutions?
                                   .Where(e => startTypeFilter == StartType.All ||
                                    startTypeFilter == StartType.Scheduled && e.ScheduleId is not null ||
                                    startTypeFilter == StartType.Manual && e.ScheduleId is null) // Limit visible step types based on start type filter
                                   .Where(e => !jobFilter.Any() || jobFilter.Contains(e.JobName)) // Limit visible step types based on job filter
                                   //.Where(s => !TagFilter.Any() || s.Tags.Any(t => TagFilter.Contains(t.TagName)) == true) // Limit visible step types based on tag filter
                                   .Where(s => !stepStatusFilter.Any() || stepStatusFilter.Contains(s.ExecutionStatus)) // Limit visible step types based on step status filter
                                   .Where(s => !stepFilter.Any() || stepFilter.Contains((s.StepName, s.StepType))) // Limit visible step types based on step filter
                                   .Select(s => s.StepType)
                                   .Distinct()
                                   .OrderBy(j => j) ?? Enumerable.Empty<StepType>()"
                                OnChange="StateHasChanged">
                    <TitleTemplate>
                        <CxIcon Icon="FeatherIcon.Tool" />
                        Step type
                    </TitleTemplate>
                    <ItemTemplate Context="item">
                        <StepTypeIconComponent StepType="item" />
                        @item.ToString()
                    </ItemTemplate>
                </FilterDropdown>
            }

            @if (!showSteps)
            {
                <FilterDropdown TItem="ExecutionStatus"
                                FilterSet="jobStatusFilter"
                                Items="executions?
                                   .Where(e => startTypeFilter == StartType.All ||
                                    startTypeFilter == StartType.Scheduled && e.ScheduleId is not null ||
                                    startTypeFilter == StartType.Manual && e.ScheduleId is null) // Limit visible job statuses based on start type filter
                                   .Where(e => !jobFilter.Any() || jobFilter.Contains(e.JobName)) // Limit visible job statuses based on job filter
                                   .Select(e => e.ExecutionStatus)
                                   .Distinct()
                                   .OrderBy(s => s) ?? Enumerable.Empty<ExecutionStatus>()"
                                OnChange="StateHasChanged">
                    <TitleTemplate>
                        <CxIcon Icon="FeatherIcon.AlertCircle" />
                        Status
                    </TitleTemplate>
                    <ItemTemplate Context="item">
                        <JobExecutionStatusBadgeComponent ExecutionStatus="item" />
                    </ItemTemplate>
                </FilterDropdown>
            }
            else
            {
                <FilterDropdown TItem="StepExecutionStatus"
                                FilterSet="stepStatusFilter"
                                Items="stepExecutions?
                                   .Where(e => startTypeFilter == StartType.All ||
                                    startTypeFilter == StartType.Scheduled && e.ScheduleId is not null ||
                                    startTypeFilter == StartType.Manual && e.ScheduleId is null) // Limit visible step statuses based on start type filter
                                   .Where(e => !jobFilter.Any() || jobFilter.Contains(e.JobName)) // Limit visible step statuses based on job filter
                                   //.Where(s => !TagFilter.Any() || s.Tags.Any(t => TagFilter.Contains(t.TagName)) == true) // Limit visible step statuses based on tag filter
                                   .Where(s => !stepFilter.Any() || stepFilter.Contains((s.StepName, s.StepType))) // Limit visible step statuses based on step filter
                                   .Where(s => !stepTypeFilter.Any() || stepTypeFilter.Contains(s.StepType)) // Limit visible step statuses based on step type filter
                                   .Select(e => e.ExecutionStatus)
                                   .Distinct()
                                   .OrderBy(s => s) ?? Enumerable.Empty<StepExecutionStatus>()"
                                OnChange="StateHasChanged">
                    <TitleTemplate>
                        <CxIcon Icon="FeatherIcon.AlertCircle" />
                        Status
                    </TitleTemplate>
                    <ItemTemplate Context="item">
                        <StepExecutionStatusBadgeComponent ExecutionStatus="item" />
                    </ItemTemplate>
                </FilterDropdown>
                <FilterDropdown TItem="string"
                                FilterSet="tagFilter"
                                Items="stepExecutions?
                                   .Where(e => startTypeFilter == StartType.All ||
                                    startTypeFilter == StartType.Scheduled && e.ScheduleId is not null ||
                                    startTypeFilter == StartType.Manual && e.ScheduleId is null) // Limit visible tags based on start type filter
                                   .Where(e => !jobFilter.Any() || jobFilter.Contains(e.JobName)) // Limit visible tags based on job filter
                                   .Where(s => !stepFilter.Any() || stepFilter.Contains((s.StepName, s.StepType))) // Limit visible tags based on step filter
                                   .Where(s => !stepTypeFilter.Any() || stepTypeFilter.Contains(s.StepType)) // Limit visible tags based on step type filter
                                   .Where(s => !stepStatusFilter.Any() || stepStatusFilter.Contains(s.ExecutionStatus)) // Limit visible tags based on step status filter
                                   .SelectMany(e => e.Tags.Select(t => t.TagName) ?? Enumerable.Empty<string>())
                                   .Distinct()
                                   .OrderBy(s => s) ?? Enumerable.Empty<string>()"
                                OnChange="StateHasChanged">
                    <TitleTemplate>
                        <CxIcon Icon="FeatherIcon.Tag" />
                        Tag
                    </TitleTemplate>
                </FilterDropdown>

            }

            <HxButton Size="ButtonSize.Small" Color="ThemeColor.None" CssClass="btn-auto"
                      @onclick="() => { jobStatusFilter.Clear(); stepStatusFilter.Clear(); jobFilter.Clear(); stepFilter.Clear(); stepTypeFilter.Clear(); tagFilter.Clear(); }">
                <CxIcon Icon="FeatherIcon.X" />
                Reset
            </HxButton>
        </HxButtonGroup>
    </div>
    <div class="col-xl-auto mt-3 mt-xl-0 d-flex align-items-center">
        <div class="form-check form-check-inline">
            <input type="radio" class="form-check-input" id="radio_all"
                   checked=@(startTypeFilter == StartType.All)
                   @onchange="() => startTypeFilter = StartType.All">
            <label class="form-check-label" for="radio_all">All</label>
        </div>
        <div class="form-check form-check-inline">
            <input type="radio" class="form-check-input" id="radio_scheduled"
                   checked=@(startTypeFilter == StartType.Scheduled)
                   @onchange="() => startTypeFilter = StartType.Scheduled">
            <label class="form-check-label" for="radio_scheduled">Scheduled</label>
        </div>
        <div class="form-check form-check-inline">
            <input type="radio" class="form-check-input" id="radio_manual"
                   checked=@(startTypeFilter == StartType.Manual)
                   @onchange="() => startTypeFilter = StartType.Manual">
            <label class="form-check-label" for="radio_manual">Manual</label>
        </div>
    </div>
</div>

<div class="card shadow-sm pt-2 mt-3 my-3">
    @if (!showSteps && !showGraph)
    {
        <JobExecutionsTableComponent Executions="FilteredExecutions" />
    }
    else if (!showSteps)
    {
        <JobExecutionsGraphComponent Executions="FilteredExecutions" />
    }
    else if (!showGraph)
    {
        <StepExecutionsTableComponent Executions="FilteredStepExecutions" />
    }
    else
    {
        <StepExecutionsGraphComponent Executions="FilteredStepExecutions" />
    }
</div>
