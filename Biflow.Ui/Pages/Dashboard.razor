@page "/dashboard"

<PageTitle>Dashboard | Biflow</PageTitle>

<h4>Dashboard</h4>

<div class="btn-toolbar mt-3">
    <HxButton Size="ButtonSize.Small" Color="ThemeColor.Primary" OnClick="LoadData" Enabled="!loading">
        <CxIcon Icon="FeatherIcon.RefreshCw" />
        Load report
    </HxButton>
</div>

<div class="row mt-3">
    <div class="col-auto d-inline-flex align-items-center">
        <label>From:</label>
        <input @bind-value="fromDate" class="form-control form-control-sm ms-2" type="date">
        <label class="ms-4">To:</label>
        <input @bind-value="toDate" class="form-control form-control-sm ms-2" type="date">
    </div> 
</div>

<div class="row mt-3">
    <div class="col-auto">
        <div class="form-check form-check-inline">
            <input type="checkbox" class="form-check-input" id="only_schedule"
                   @bind-value="onlyScheduled"
                   checked=@onlyScheduled>
            <label class="form-check-label" for="only_schedule">Only scheduled executions</label>
        </div>
        <div class="form-check form-check-inline ms-3">
            <input type="checkbox" class="form-check-input" id="include_deleted"
                   @bind-value="includeDeleted"
                   checked=@includeDeleted>
            <label class="form-check-label" for="include_deleted">Include deleted jobs/steps</label>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-xl">
        <div class="card shadow-sm">
            <h6 class="card-header">
                <CxIcon Icon="FeatherIcon.Clock" />
                &nbsp;
                Average execution duration
            </h6>
            <div class="card-body">
                @if (!reportLoaded)
                {
                    <p class="@ReportNotLoadedClass">@ReportNotLoadedMessage</p>
                }
                <LineChart Dataset="durationDataset" />
            </div>
        </div>
    </div>
    <div class="col-xl mt-4 mt-xl-0">
        <div class="card shadow-sm">
            <h6 class="card-header">
                <CxIcon Icon="FeatherIcon.Percent" />
                &nbsp;
                Job success rate
            </h6>
            <div class="card-body">
                @if (!reportLoaded)
                {
                    <p class="@ReportNotLoadedClass">@ReportNotLoadedMessage</p>
                }
                <BarChart Dataset="successRateDataset" />
            </div>
        </div>
    </div>
</div>
<div class="row my-4">
    <div class="col-xl">
        <div class="card shadow-sm">
            <h6 class="card-header">
                <CxIcon Icon="FeatherIcon.Activity" />
                &nbsp;
                Number of executions
            </h6>
            <div class="card-body">
                @if (!reportLoaded)
                {
                    <p class="@ReportNotLoadedClass">@ReportNotLoadedMessage</p>
                }
                <LineChart Dataset="noOfExecutionsDataset" />
            </div>
        </div>
    </div>
    <div class="col-xl mt-4 mt-xl-0 d-flex align-items-stretch">
        <div class="card shadow-sm flex-fill">
            <h6 class="card-header">
                <CxIcon Icon="FeatherIcon.AlertOctagon" />
                &nbsp;
                Top 5 failing steps
            </h6>
            <div class="card-body @(reportLoaded ? "px-0" : null)">
                @if (!reportLoaded)
                {
                    <p class="@ReportNotLoadedClass">@ReportNotLoadedMessage</p>
                }
                else
                {
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr>
                                <th></th>
                                <th>Step</th>
                                <th>Job</th>
                                <th>Success %</th>
                                <th># of executions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (topFailedSteps is not null)
                            {
                                @for (int i = 0; i < topFailedSteps.Length; i++)
                                {
                                    <tr>
                                        <td>@(i + 1)</td>
                                        <td class="align-middle">
                                            <StepTypeIconComponent StepType_="topFailedSteps[i].StepType" />
                                            @topFailedSteps[i].StepName
                                        </td>
                                        <td>
                                            @topFailedSteps[i].JobName
                                        </td>
                                        <td>@topFailedSteps[i].SuccessPercent.FormatPercentage(2)</td>
                                        <td>@topFailedSteps[i].NoOfExecutions</td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                }
            </div>
        </div>
    </div>
</div>
