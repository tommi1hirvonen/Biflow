@page "/datatables/{Page?}/{TableId:guid?}"

@inject IDbContextFactory<BiflowContext> DbContextFactory
@inject MarkupHelperService MarkupHelper

<PageTitle>Data Tables | Biflow</PageTitle>

<h4>Data Tables</h4>

<AuthorizeView Roles="Admin, Editor">
    <ul class="nav nav-pills mt-3 mb-4" role="tablist">
        <li class="nav-item" role="presentation">
            <NavLink class="nav-link" href="datatables/edit" Match="NavLinkMatch.All">
                @MarkupHelper.FromFile("icons/feather/table.svg")
                Edit data
            </NavLink>
        </li>
        <li class="nav-item" role="presentation">
            <NavLink class="nav-link" href="datatables/manage">
                @MarkupHelper.FromFile("icons/feather/settings.svg")
                Manage tables
            </NavLink>
        </li>
    </ul>
</AuthorizeView>

@if (Page == "edit")
{
    <DataTableEditComponent Tables="Tables" TableId="TableId" />
}
else if (Page == "manage")
{
    <AuthorizeView Roles="Admin, Editor">
        <DataTablesManageComponent Tables="Tables" Connections="Connections" />
    </AuthorizeView>
}
else if (Page == "import")
{
    <DataTableImportComponent TableId="TableId" />
}
else
{
    <p>Sorry, nothing at this address.</p>
}

@code {
    [Parameter] public string? Page { get; set; }

    [Parameter] public Guid? TableId { get; set; }

    private List<MasterDataTable>? Tables { get; set; }

    private List<SqlConnectionInfo>? Connections { get; set; }

    protected override async Task OnInitializedAsync()
    {
        using var context = await Task.Run<BiflowContext>(DbContextFactory.CreateDbContext);
        Tables = await context.MasterDataTables
            .Include(t => t.Connection)
            .Include(t => t.Lookups)
            .ThenInclude(t => t.LookupTable)
            .OrderBy(t => t.DataTableName)
            .ToListAsync();
        Connections = await context.SqlConnections
            .OrderBy(c => c.ConnectionName)
            .ToListAsync();
    }
}
