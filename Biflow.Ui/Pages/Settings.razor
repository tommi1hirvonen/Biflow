@page "/settings/{Page?}/"
@page "/settings/integrations/{IntegrationsPage?}"

@attribute [Authorize(Roles = $"{Roles.Admin}, {Roles.SettingsEditor}")]

@inject IConfiguration Configuration
@inject NavigationManager NavigationManager

<h4>Settings</h4>

<div class="mt-3 mb-4">
    <AuthorizeView Roles="@(Roles.Admin)">
        <ul class="nav nav-tabs" role="tablist">
            <li class="nav-item" role="presentation">
                <NavLink class="nav-link" href="settings/integrations">
                    <SvgIcon Icon="LucideIcon.Unplug" />
                    Integrations
                </NavLink>
            </li>
            <li class="nav-item" role="presentation">
                <NavLink class="nav-link" href="settings/users" Match="NavLinkMatch.All">
                    <SvgIcon Icon="FeatherIcon.Users" />
                    Users
                </NavLink>
            </li>
            <li class="nav-item" role="presentation">
                <NavLink class="nav-link" href="settings/subscriptions">
                    <SvgIcon Icon="FeatherIcon.Mail" />
                    Subscriptions
                </NavLink>
            </li>
            <li class="nav-item" role="presentation">
                <NavLink class="nav-link" href="settings/apikeys">
                    <SvgIcon Icon="LucideIcon.GlobeLock" />
                    API keys
                </NavLink>
            </li>
        </ul>
    </AuthorizeView>

</div>

<div class="row">
    @if (IntegrationsPage is not null)
    {
        <div class="col-auto">
            <ul class="nav flex-column nav-pills small" style="gap: 0.4rem;">
                <li class="nav-item">
                    <NavLink class="nav-link" href="settings/integrations/connections">
                        <SvgIcon Icon="FeatherIcon.Database" />
                        &nbsp;
                        Connections
                    </NavLink>
                </li>
                <li class="nav-item">
                    <NavLink class="nav-link" href="settings/integrations/appregistrations">
                        <SvgIcon Icon="FeatherIcon.Globe" />
                        &nbsp;
                        App registrations
                    </NavLink>
                </li>
                <li class="nav-item">
                    <NavLink class="nav-link" href="settings/integrations/datafactory">
                        <SvgIcon Icon="LucideIcon.Factory" />
                        &nbsp;
                        Azure Data Factory
                    </NavLink>
                </li>
                <li class="nav-item">
                    <NavLink class="nav-link" href="settings/integrations/synapse">
                        <SvgIcon Icon="FeatherIcon.Cpu" />
                        &nbsp;
                        Azure Synapse
                    </NavLink>
                </li>
                <li class="nav-item">
                    <NavLink class="nav-link" href="settings/integrations/functions">
                        <SvgIcon Icon="FeatherIcon.Zap" />
                        &nbsp;
                        Azure Functions
                    </NavLink>
                </li>
                <li class="nav-item">
                    <NavLink class="nav-link" href="settings/integrations/databricks">
                        <SvgIcon Icon="LucideIcon.Layers3" />
                        &nbsp;
                        Azure Databricks
                    </NavLink>
                </li>
                <li class="nav-item">
                    <NavLink class="nav-link" href="settings/integrations/blobstorage">
                        <SvgIcon Icon="LucideIcon.Container" />
                        &nbsp;
                        Azure Blob Storage
                    </NavLink>
                </li>
                <li class="nav-item">
                    <NavLink class="nav-link" href="settings/integrations/dbt">
                        <SvgIcon Icon="LucideIcon.Blocks" />
                        &nbsp;
                        dbt Cloud&trade;
                    </NavLink>
                </li>
                <li class="nav-item">
                    <NavLink class="nav-link" href="settings/integrations/qlikcloud">
                        <SvgIcon Icon="LucideIcon.ScatterChart" />
                        &nbsp;
                        Qlik Cloud&reg;
                    </NavLink>
                </li>
                <li class="nav-item">
                    <NavLink class="nav-link" href="settings/integrations/credentials">
                        <SvgIcon Icon="FeatherIcon.Key" />
                        &nbsp;
                        Credentials
                    </NavLink>
                </li>
            </ul>
        </div>
    }
    <div class="col">
        @if (Page == "users")
        {
            <AuthorizeView Roles="@(Roles.Admin)">
                <Authorized>
                    <UsersList />
                </Authorized>
                <NotAuthorized>
                    <Unauthorized />
                </NotAuthorized>
            </AuthorizeView>
        }
        else if (Page == "subscriptions")
        {
            <AuthorizeView Roles="@(Roles.Admin)">
                <Authorized>
                    <AllSubscriptions />
                </Authorized>
                <NotAuthorized>
                    <Unauthorized />
                </NotAuthorized>
            </AuthorizeView>
        }
        else if (Page == "apikeys")
        {
            <AuthorizeView Roles="@Roles.Admin">
                <Authorized>
                    <ApiKeysList />
                </Authorized>
                <NotAuthorized>
                    <Unauthorized />
                </NotAuthorized>
            </AuthorizeView>
        }
        else if (IntegrationsPage == "connections")
        {
            <ConnectionsList />
        }
        else if (IntegrationsPage == "appregistrations")
        {
            <AppRegistrationsList />
        }
        else if (IntegrationsPage == "datafactory")
        {
            <DataFactoriesList />
        }
        else if (IntegrationsPage == "synapse")
        {
            <SynapseWorkspacesList />
        }
        else if (IntegrationsPage == "functions")
        {
            <FunctionAppsList />
        }
        else if (IntegrationsPage == "qlikcloud")
        {
            <QlikCloudEnvironmentsList />
        }
        else if (IntegrationsPage == "databricks")
        {
            <DatabricksWorkspacesList />
        }
        else if (IntegrationsPage == "dbt")
        {
            <DbtAccountsList />
        }
        else if (IntegrationsPage == "blobstorage")
        {
            <BlobClientsList />
        }
        else if (IntegrationsPage == "credentials")
        {
            <CredentialsList />
        }
        else
        {
            <p>Sorry, nothing at this address.</p>
        }
    </div>
</div>

@code {
    [Parameter] public string? Page { get; set; }

    [Parameter] public string? IntegrationsPage { get; set; }

    protected override void OnParametersSet()
    {
        if (NavigationManager.Uri.EndsWith("integrations") && IntegrationsPage is null)
        {
            NavigationManager.NavigateTo("settings/integrations/connections");
        }
    }

    protected override void OnInitialized()
    {
        if (Page is not null || IntegrationsPage is not null)
        {
            return;
        }

        NavigationManager.NavigateTo("settings/integrations/connections");
    }
}
