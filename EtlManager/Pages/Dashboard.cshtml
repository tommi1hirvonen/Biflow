@page
@model EtlManager.Pages.DashboardModel
@using Microsoft.AspNetCore.Hosting
@inject IWebHostEnvironment WebHostEnvironment
@{
    ViewData["Title"] = "Dashboard";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-lg-3 d-flex align-items-center">
            <h4>Dashboard</h4>
        </div>
        <div class="col-lg-9 d-flex justify-content-end">
            <form class="form-inline">
                <input type="hidden" asp-for="LoadReport" value="true" />
                <div id="spinner_loading" class="spinner-border text-primary align-middle" hidden role="status">
                    <span class="sr-only">Loading...</span>
                </div>
                <button type="submit" class="btn btn-sm btn-primary ml-3" onclick="$('#spinner_loading').removeAttr('hidden');">
                    @Html.Raw(System.IO.File.ReadAllText(System.IO.Path.Combine(WebHostEnvironment.WebRootPath, "icons/feather/refresh-cw.svg")))
                    Load report
                </button>
                <label class="ml-5">Date until:</label>
                <input asp-for="DateTimeUntil" class="form-control form-control-sm ml-2" type="date">
                <label class="ml-5">Interval (d):</label>
                <input asp-for="IntervalDays" class="form-control form-control-sm col-1 ml-2">
                <div class="custom-control custom-checkbox custom-control-inline ml-5">
                    <input type="checkbox" class="custom-control-input" asp-for="IncludeDeleted">
                    <label class="custom-control-label" asp-for="IncludeDeleted">Include deleted jobs/steps</label>
                </div>
            </form>
        </div>
    </div>
</div>

@if (!Model.LoadReport)
{
    <div class="alert alert-light show mt-5" role="alert" style="display: inline-block;">
        Load report to show statistics
    </div>
}

@if (Model.LoadReport)
{
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="card shadow-sm col-lg mr-lg-3 mb-lg-3 mb-3 pt-3">
                <h6>Average execution duration</h6>
                <canvas class="my-4 w-100" id="myChart1" width="900" height="380"></canvas>
            </div>
            <div class="card shadow-sm col-lg ml-lg-3 mb-lg-3 mt-lg-0 my-3 pt-3">
                <h6>Job success rate</h6>
                <canvas class="my-4 w-100" id="myChart2" width="900" height="380"></canvas>
            </div>
        </div>
        <div class="row">
            <div class="card shadow-sm col-lg mr-lg-3 mt-lg-3 my-3 pt-3">
                <h6>Number of executions</h6>
                <canvas class="my-4 w-100" id="myChart3" width="900" height="380"></canvas>
            </div>
            <div class="card shadow-sm col-lg ml-lg-3 mt-lg-3 my-3 pt-3">
                <h6>Top 5 failing steps</h6>
                <div class="row mt-4">
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr>
                                <th></th>
                                <th>Step</th>
                                <th>Job</th>
                                <th>Success %</th>
                                <th># of executions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @for (int i = 0; i < Model.TopFailedSteps.Count; i++)
                            {
                                <tr>
                                    <td>@(i + 1)</td>
                                    <td>
                                        <a class="text-dark" asp-page="/Jobs/JobDetails/StepDetails/StepHistory" asp-route-id="@Model.TopFailedSteps[i].StepId">
                                            @Model.TopFailedSteps[i].StepName
                                        </a>
                                    </td>
                                    <td>
                                        <a class="text-dark" asp-page="/Jobs/JobDetails/History" asp-route-id="@Model.TopFailedSteps[i].JobId">
                                            @Model.TopFailedSteps[i].JobName
                                        </a>
                                    </td>
                                    <td>@Html.DisplayFor(item => Model.TopFailedSteps[i].SuccessPercent)</td>
                                    <td>@Model.TopFailedSteps[i].NoOfExecutions</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>


    @section Scripts {
        <script src="~/lib/Chart.js/Chart.min.js"></script>
        <script src="~/lib/Chart.js/Chart.bundle.js"></script>
        <script type="text/javascript">

        $(function () {

            // Average execution duration in minutes by date
            var datasets1 = [
                    @Html.Raw(GetDurationDatasetString())
            ];

            var ctx1 = document.getElementById('myChart1')

            var myChart1 = new Chart(ctx1, {
                type: 'line',
                data: {
                    datasets: datasets1
                },
                options: {
                    scales: {
                        yAxes: [{
                            ticks: {
                                beginAtZero: true
                            },
                            scaleLabel: {
                                display: true,
                                labelString: 'min'
                            }
                        }],
                        xAxes: [{
                            type: 'time'
                        }]
                    }
                }
            })

            // Job success rates
            var ctx2 = document.getElementById('myChart2')
            var myChart2 = new Chart(ctx2, {
                type: 'horizontalBar',
                data: {
                    labels: [
                        @Html.Raw(string.Join(',', Model.Jobs.Select(job => "'" + job.JobName + "'")))
                    ],
                    datasets: [{
                        data: [
                            @string.Join(',', Model.Jobs.Select(job => decimal.Round(job.SuccessPercent, 2).ToString().Replace(',', '.')))
                        ],
                        lineTension: 0,
                        backgroundColor: [
                            @Html.Raw(string.Join(',', Model.Jobs.Select(job => "'" + Model.JobColors[job.JobName] + "'")))
                        ]
                    }]
                },
                options: {
                    scales: {
                        xAxes: [{
                            ticks: {
                                beginAtZero: true,
                                max: 100,
                                min: 0,
                                stepSize: 10,
                                callback: function (value, index, values) {
                                    return value + '%';
                                }
                            }
                        }]
                    },
                    legend: {
                        display: false
                    }
                }
            })


            // Number of job executions by date
            var datasets3 = [
                    @Html.Raw(GetNoOfExecutionsDatasetString())
            ];

            var ctx3 = document.getElementById('myChart3')

            var myChart3 = new Chart(ctx3, {
                type: 'line',
                data: {
                    datasets: datasets3
                },
                options: {
                    scales: {
                        yAxes: [{
                            ticks: {
                                beginAtZero: true,
                                stepSize: 1
                            }
                        }],
                        xAxes: [{
                            type: 'time'
                        }]
                    }
                }
            })

        })

        </script>
    }

}


@{
    string GetDurationDatasetString()
    {
        return string.Join(',',
            Model.TimeSeriesItems.Select((e, index) =>
                "{label: '" + e.Key + "', fill: false, backgroundColor: '" + Model.JobColors[e.Key] + "', borderColor: '" + Model.JobColors[e.Key] + "', data: [" +
                    string.Join(',', e.Value.Select(v => @"{t: new Date(""" + v.Date.ToString("yyyy-M-d")?.Replace('.', ':') + @"""), y: " + v.DurationInMinutes.ToString().Replace(',', '.') + @"}")) +
                "]}")
            );
    }

    string GetNoOfExecutionsDatasetString()
    {
        return string.Join(',',
            Model.TimeSeriesItems.Select((e, index) =>
                "{label: '" + e.Key + "', fill: false, backgroundColor: '" + Model.JobColors[e.Key] + "', borderColor: '" + Model.JobColors[e.Key] + "', data: [" +
                    string.Join(',', e.Value.Select(v => @"{t: new Date(""" + v.Date.ToString("yyyy-M-d")?.Replace('.', ':') + @"""), y: " + v.NumberOfExecutions + @"}")) +
                "]}")
            );
    }
}
